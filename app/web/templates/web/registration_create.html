{% extends "web/base.html" %}
{% load static %}

{% block title %}Yeni Kayıt Oluştur{% endblock %}

{% block content %}
<div class="form-page">
  <div class="card form-card">
    <div class="card-top">
      <h1 class="brand-title">Yeni Kayıt Oluştur</h1>
    </div>

    {% if patient %}
      <div class="banner">
        <strong>Hasta:</strong> {{ patient.first_name }} {{ patient.last_name }}
        — <span class="muted">T.C: {{ patient.national_id }}</span>
      </div>
    {% endif %}

    <form method="post" id="regForm" class="form stack">
      {% csrf_token %}
      <div class="grid">
        <div class="field">
          <label for="id_department">Bölüm</label>
          {{ form.department }}
        </div>

        {{ form.doctor.as_hidden }}

        <div class="field">
          <label>Doktor</label>
          {% if doctors %}
            <div class="doc-scroll">
              <ul class="doc-grid" id="doctorGrid">
                {% for d in doctors %}
                <li>
                  <button
                    type="button"
                    class="doc-card{% if selected_doctor_id and selected_doctor_id|stringformat:'s' == d.id|stringformat:'s' %} selected{% endif %}"
                    data-id="{{ d.id }}"
                    aria-pressed="{% if selected_doctor_id and selected_doctor_id|stringformat:'s' == d.id|stringformat:'s' %}true{% else %}false{% endif %}">
                    <span class="avatar">{{ d.first_name|first }}{{ d.last_name|first }}</span>
                    <span class="info">
                      <span class="name">{{ d.first_name }} {{ d.last_name }}</span>
                      <span class="meta">{{ d.department.name }}</span>
                    </span>
                    <span class="tick">✔</span>
                  </button>
                </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <p class="muted">Bu bölüm için doktor bulunamadı.</p>
          {% endif %}
        </div>

        <div class="field">
          <label for="id_notes">Not</label>
          {{ form.notes }}
        </div>
      </div>

      <div class="buttons-row center">
        <button type="submit" class="btn btn-wide">Kaydı Oluştur</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dep = document.getElementById("id_department");
    const hiddenDoctor = document.getElementById("id_doctor");
    const grid = document.getElementById("doctorGrid");
    dep?.addEventListener("change", () => {
      const url = new URL(window.location.href);
      url.searchParams.set("department", dep.value || "");
      window.location.href = url.toString();
    });

    if (grid && hiddenDoctor) {
      grid.addEventListener("click", (e) => {
        const btn = e.target.closest(".doc-card");
        if (!btn) return;
        grid.querySelectorAll(".doc-card.selected").forEach(el=>{
          el.classList.remove("selected");
          el.setAttribute("aria-pressed","false");
        });
        btn.classList.add("selected");
        btn.setAttribute("aria-pressed","true");
        hiddenDoctor.value = btn.dataset.id;
      });
    }
  });
  </script>

</body>
</html>
{% endblock %}