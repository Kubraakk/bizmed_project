{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="{% static 'web/style.css' %}">
  <title>Yeni Hasta Kaydƒ±</title>
</head>
<body class="page">

  <div class="split">
    <div class="split-left">
      <div class="side">
        <img src="{% static 'web/bizmed-logo.png' %}" alt="Bizmed" class="side-logo xl">
      </div>
    </div>
    <div class="split-right">
      <div class="card shift-right">
        <div class="card-top">
          <a href="{% url 'home' %}" class="btn-ghost top-left small">üè† Ana Sayfa</a>
          <h1 class="brand-title">Yeni Hasta Kaydƒ±</h1>
        </div>

        {% if messages %}
          <div class="messages">
            {% for message in messages %}
              <div class="banner {{ message.tags }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="post" id="patientForm" class="form stack" novalidate>
          {% csrf_token %}
          <div class="grid">

            <div class="field">
              <label for="id_national_id">T.C. Kimlik No</label>
              {{ form.national_id }}
              {% for error in form.national_id.errors %}
                <p class="error-text">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="field">
              <label for="id_first_name">Ad</label>
              {{ form.first_name }}
              {% for error in form.first_name.errors %}
                <p class="error-text">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="field">
              <label for="id_last_name">Soyad</label>
              {{ form.last_name }}
              {% for error in form.last_name.errors %}
                <p class="error-text">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="field">
              <label for="id_phone">Telefon</label>
              {{ form.phone }}
              {% for error in form.phone.errors %}
                <p class="error-text">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="field">
              <label for="id_address">Adres</label>
              {{ form.address }}
            </div>

          </div>

          <div class="buttons-row center">
            <button type="submit" class="btn btn-wide">Kaydet ve Kayƒ±t A√ß</button>
          </div>
        </form>

        <div class="card-footer">
          <a href="{% url 'tckn-search' %}" class="btn-ghost">üîç T.C. ile Hasta Sorgula</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("patientForm");

      const tcknInput = document.getElementById("id_national_id");
      const firstInput = document.getElementById("id_first_name");
      const lastInput  = document.getElementById("id_last_name");
      const phoneInput = document.getElementById("id_phone");

      function showTooltip(input, message) {
        removeTooltip(input);
        input.classList.add("input-error");
        const tip = document.createElement("div");
        tip.className = "error-tooltip";
        tip.innerText = message;
        input.parentNode.appendChild(tip);
        const removeOnce = () => removeTooltip(input);
        input.addEventListener("input", removeOnce, { once: true });
        input.addEventListener("change", removeOnce, { once: true });
      }
      function removeTooltip(input) {
        if (!input) return;
        input.classList.remove("input-error");
        const tip = input.parentNode.querySelector(".error-tooltip");
        if (tip) tip.remove();
      }

      /* ---------------- TCKN ---------------- */
      function validateTCKN(tckn) {
        if (!/^[1-9]\d{10}$/.test(tckn)) return false;
        const d = tckn.split("").map(Number);
        const odd  = d[0] + d[2] + d[4] + d[6] + d[8];
        const even = d[1] + d[3] + d[5] + d[7];
        if ((((odd * 7) - even) % 10) !== d[9]) return false;
        if ((d.slice(0, 10).reduce((a,b)=>a+b,0) % 10) !== d[10]) return false;
        return true;
      }

      /* ---------------- Telefon normalize & maske ---------------- */
      function normalizePhone(raw) {
        let v = (raw || "").replace(/\D/g, ""); // sadece rakam
        if (v.startsWith("90")) v = v.slice(2); // √ºlke kodunu at
        if (!v.startsWith("0")) v = "0" + v;    // ba≈üƒ±na 0 ekle
        return v.slice(0, 11);                  // 11 haneye sƒ±nƒ±rla
      }
      function formatPhone11(v11) {
        let out = "+90 ";
        if (v11.length > 1) out += `(${v11.slice(1,4)}`;
        if (v11.length >= 4) out += `) ${v11.slice(4,7)}`;
        if (v11.length >= 7) out += ` ${v11.slice(7,9)}`;
        if (v11.length >= 9) out += ` ${v11.slice(9,11)}`;
        return out;
      }

      if (tcknInput) {
        tcknInput.setAttribute("maxlength", "11");
        tcknInput.addEventListener("input", () => {
          tcknInput.value = tcknInput.value.replace(/\D/g, "");
        });
      }

      if (phoneInput) {
        phoneInput.setAttribute("inputmode", "numeric");
        phoneInput.setAttribute("autocomplete", "tel");
        phoneInput.addEventListener("input", () => {
          const v11 = normalizePhone(phoneInput.value);
          phoneInput.value = formatPhone11(v11);
          removeTooltip(phoneInput);
        });

        if (phoneInput.value) {
          const v11 = normalizePhone(phoneInput.value);
          phoneInput.value = formatPhone11(v11);
        }
      }

      document.querySelectorAll(".error-text").forEach(err => {
        const field = err.closest(".field").querySelector("input");
        if (field) showTooltip(field, err.textContent.trim());
      });

      form.addEventListener("submit", (e) => {
        [tcknInput, firstInput, lastInput, phoneInput].forEach(removeTooltip);

        let ok = true;

        if (firstInput && !firstInput.value.trim()) { showTooltip(firstInput, "Bu alan zorunludur"); ok = false; }
        if (lastInput  && !lastInput.value.trim())  { showTooltip(lastInput , "Bu alan zorunludur"); ok = false; }

        if (tcknInput) {
          const t = (tcknInput.value || "").replace(/\D/g, "");
          if (!validateTCKN(t)) { showTooltip(tcknInput, "Ge√ßerli bir T.C. Kimlik Numarasƒ± giriniz"); ok = false; }
        }

        if (phoneInput) {
          let p = normalizePhone(phoneInput.value);
          if (!/^05\d{9}$/.test(p)) {
            showTooltip(phoneInput, "Ge√ßerli bir telefon numarasƒ± giriniz");
            ok = false;
          } else {
            phoneInput.value = formatPhone11(p);
          }
        }

        if (!ok) {
          e.preventDefault();
          const firstErr = form.querySelector(".input-error");
          if (firstErr) firstErr.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      });
    });
    </script>
    </body>
    </html>
